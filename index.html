<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MonitoringPV</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    .param-card {
      width: 6rem;
      height: 6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .param-card:hover {
      transform: scale(1.05);
    }
    @media (min-width: 640px) {
      .param-card {
        width: 7rem;  /* sm:w-28 */
        height: 7rem; /* sm:h-28 */
      }
    }
    @media (min-width: 768px) {
      .param-card {
        width: 8rem;  /* md:w-32 */
        height: 8rem; /* md:h-32 */
      }
    }
    /* ==== LINGKARAN SUHU ==== */
    #water { transition: stroke-dashoffset 0.5s ease; }
    #valueDisplay {
      position: absolute;
      font-weight: bold;
      font-size: 3.5rem;
      color: deepskyblue;
      left: 50%;
      transform: translateX(-50%);
      top: 200px;
    }
    #emoji {
      position: absolute;
      font-size: 4rem;
      left: 50%;
      top: 120px;
      transform: translate(-50%, -50%);
    }
    #emojiText {
      position: absolute;
      font-size: 2rem;
      left: 50%;
      top: 170px;
      transform: translateX(-50%);
      color: gray;
      text-align: center;
    }
    #container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: auto;
    }
    </style>
</head>
  <body class="bg-white min-h-screen text-gray-900 font-sans flex flex-col">
  
  <!-- Header -->
  <header class="fixed top-0 left-0 w-full z-50 bg-white/40 backdrop-blur-xl border-b border-white/20 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16 sm:h-20">
        
        <!-- Logo + Judul -->
        <div class="flex items-center gap-3 flex-wrap">
          <img src="assets/images/drpm.png" alt="Logo DRPM" class="h-14 w-14 sm:h-20 sm:w-20 object-contain">
          <img src="assets/images/untad.png" alt="Logo Untad" class="h-5 w-5 sm:h-8 sm:w-8 object-contain">
          <div>
            <h1 class="text-base sm:text-xl md:text-2xl font-bold text-gray-800 tracking-tight">Sistem Monitoring</h1>
            <p class="text-xs sm:text-sm text-gray-500">Universitas Tadulako</p>
          </div>
        </div>
        <!-- Navigasi (Desktop) -->
        <nav class="hidden md:flex items-center gap-8">
          <button onclick="showPage('utama', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Utama</button>
          <button onclick="showPage('grafik', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Grafik</button>
          <button onclick="showPage('histori', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Histori</button>
        </nav>

        <!-- Jam -->
        <span id="clock" class="block font-mono text-sm sm:text-base text-gray-600"></span>

        <!-- Tombol Mobile -->
        <div class="md:hidden">
          <button id="menuBtn" class="focus:outline-none text-xl text-gray-700 hover:text-blue-600 transition-colors duration-300">‚ò∞</button>
        </div>
      </div>
    </div>
    <!-- Menu Mobile -->
    <div id="mobileMenu" class="hidden md:hidden absolute top-20 inset-x-0 bg-white/95 backdrop-blur-xl border-t border-gray-200 shadow-lg animate-slide-down">
      <nav class="flex flex-col px-6 py-4 space-y-4">
        <button onclick="showPage('utama', this)" class="nav-link text-left">Utama</button>
        <button onclick="showPage('grafik', this)" class="nav-link text-left">Grafik</button>
        <button onclick="showPage('histori', this)" class="nav-link text-left">Histori</button>
      </nav>
    </div>
  </header>
    
    <div class="flex-1 pt-24">
      <div id="utama">
        <!-- ==== LINGKARAN SUHU ==== -->
        <div class="flex justify-center mt-4 mb-6">
          <div id="container">
            <svg id="hoseSvg" width="300" height="300" viewBox="0 0 300 300">
              <circle id="water" cx="150" cy="150" r="120"
                      stroke="deepskyblue" stroke-width="30" fill="none"
                      stroke-linecap="round"
                      transform="rotate(140 150 150)" />
            </svg>
            <div id="emoji">üå°Ô∏è</div>
            <div id="emojiText">Suhu</div>
            <div id="valueDisplay">-</div>
          </div>
        </div>
        <!-- Nilai Utama -->
        <div class="flex flex-col items-center mb-6">
          <div class="text-6xl font-bold text-gray-900" id="suhuUtama">-</div>
          <div class="text-lg text-gray-600" id="kondisiCuaca">-</div>
          <h3 class="text-xl font-bold mt-2"><i class="fas fa-map-marker-alt text-red-500"></i> Rumah Penelitian</h3>
        </div>

        <div class="flex flex-wrap justify-center gap-4 p-4">
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-thermometer-half text-orange-400"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="suhu1">- ¬∞C</div>
            <div class="text-xs sm:text-sm text-gray-500">Suhu 1</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-tint text-blue-100"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kelembaban1">- %</div>
            <div class="text-xs sm:text-sm text-gray-500">Kelembapan 1</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-thermometer-half text-orange-500"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="suhu2">- ¬∞C</div>
            <div class="text-xs sm:text-sm text-gray-500">Suhu 2</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-tint text-blue-200"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kelembaban2">- %</div>
            <div class="text-xs sm:text-sm text-gray-500">Kelembapan 2</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-wind text-gray-200"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kecepatan_angin">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Kecepatan Angin</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-compass text-gray-300"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="arah_angin">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Arah Angin</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-sun text-yellow-300"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="uv_index">-</div>
            <div class="text-xs sm:text-sm text-gray-500">UV Index</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-sun text-yellow-400"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="uv_intensity">-</div>
            <div class="text-xs sm:text-sm text-gray-500">UV Intensity</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-sun text-yellow-500"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="irradiance">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Radiasi Matahari</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-smog text-gray-400"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="debu">- ¬µg/m¬≥</div>
            <div class="text-xs sm:text-sm text-gray-500">Debu</div>
          </div>
          <div class="param-card">
            <div class="mb-1"><i class="fas fa-cloud-showers-heavy text-blue-400"></i></div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="curah_hujan">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Curah Hujan</div>
          </div>
        </div>
      </div>
      <div id="grafik" class="hidden">
        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Suhu</h2>
            <canvas id="chartSuhu"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Kelembaban</h2>
            <canvas id="chartKelembaban"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Kecepatan Angin</h2>
            <canvas id="chartAngin"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Arah Angin</h2>
            <canvas id="compass" width="360" height="360"></canvas>
            <div id="windInfo" class="mt-4 text-center">
              <p class="text-lg font-medium text-gray-900" id="chartArahAngin">Arah: 0¬∞ (Utara)</p>
            </div>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Sinar UV</h2>
            <canvas id="chartUV"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Radiasi Matahari</h2>
            <canvas id="chartRadiasi"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Debu</h2>
            <canvas id="chartDebu"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Curah Hujan</h2>
            <canvas id="chartHujan"></canvas>
          </div>
        </div>
      </div>
      <div id="histori" class="hidden">
        <div class="p-6 bg-white rounded-2xl shadow-lg">
          <h2 class="text-lg font-semibold mb-4 text-gray-800 tracking-tight">Histori Data Sensor</h2>
          <div class="flex justify-center mb-4">
            <div class="flex items-center gap-3 bg-white px-5 py-3 rounded-2xl shadow-sm">
              <input type="date" id="startDate" class="rounded-xl border px-3 py-2 text-sm text-gray-700">
              <span class="text-gray-400 text-sm">‚Äî</span>
              <input type="date" id="endDate" class="rounded-xl border px-3 py-2 text-sm text-gray-700">
              <button id="downloadCsvBtn" class="ml-4 rounded-xl bg-blue-100 text-blue-600 px-3 py-2 text-sm font-semibold">
                Unduh Data
              </button>
            </div>
          </div>
          <div class="overflow-x-auto rounded-2xl border border-gray-200">
            <table class="min-w-full border-collapse">
              <thead>
                <tr class="bg-gray-50 text-gray-700 text-sm tracking-wide">
                  <th class="px-4 py-2">Timestamp</th>
                  <th class="px-4 py-2">Device</th>
                  <th class="px-4 py-2">Suhu1</th>
                  <th class="px-4 py-2">Kelembaban1</th>
                  <th class="px-4 py-2">Suhu2</th>
                  <th class="px-4 py-2">Kelembaban2</th>
                  <th class="px-4 py-2">UV Index</th>
                  <th class="px-4 py-2">Debu</th>
                  <th class="px-4 py-2">Curah Hujan</th>
                  <th class="px-4 py-2">Kecepatan Angin</th>
                  <th class="px-4 py-2">Arah Angin</th>
                  <th class="px-4 py-2">Irradiance</th>
                </tr>
              </thead>
              <tbody id="data-body" class="text-gray-700 text-sm divide-y divide-gray-200 text-center"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <footer class="mt-auto bg-gray-100 text-gray-700 w-full">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <button class="w-full flex justify-between items-center md:block md:cursor-default"
            onclick="toggleFooter(this)">
            <h3 class="font-bold text-sm text-gray-900">Tentang Kami</h3>
            <span class="md:hidden">+</span>
          </button>
          <ul class="mt-2 space-y-1 text-xs hidden md:block">
            <li><a href="https://untad.ac.id/" target="_blank" class="text-gray-700 hover:underline">Universitas Tadulako</a></li>
            <li><a href="https://fatek.untad.ac.id/" target="_blank" class="text-gray-700 hover:underline">Fakultas Teknik</a></li>
            <li><a href="https://elektro.fatek.untad.ac.id/" target="_blank" class="text-gray-700 hover:underline">Teknik Elektro</a></li>
          </ul>
        </div>
        <div>
          <button class="w-full flex justify-between items-center md:block md:cursor-default"
            onclick="toggleFooter(this)">
            <h3 class="font-bold text-sm text-gray-900">Layanan</h3>
            <span class="md:hidden">+</span>
          </button>
          <ul class="mt-2 space-y-1 text-xs hidden md:block">
            <li>Informasi</li>
            <li>Petunjuk Penggunaan</li>
          </ul>
        </div>
        <div>
          <button class="w-full flex justify-between items-center md:block md:cursor-default"
                  onclick="toggleFooter(this)">
            <h3 class="font-bold text-sm text-gray-900">Kontak</h3>
            <span class="md:hidden">+</span>
          </button>
          <ul class="mt-2 space-y-1 text-xs hidden md:block">
            <li>Email: info@untad.ac.id</li>
            <li>Telp: +62 451 123456</li>
            <li>Alamat: Tondo, Sulawesi Tengah</li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-200 py-3 text-center text-sm text-gray-600">
        ¬© 2025 Universitas Tadulako. Semua hak dilindungi.
      </div>
    </footer>
  <script>
    const SUPABASE_URL = "https://bryjpjzvsadfvjwqgwak.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyeWpwanp2c2FkZnZqd3Fnd2FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzA0MDUsImV4cCI6MjA3NDAwNjQwNX0.1iWQJhtE02t4JTcutIPkzxmn2qyx-Z7JCKFDQ8itCw8";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const dataBody = document.getElementById("data-body");
    const water = document.getElementById("water");
    const valueDisplay = document.getElementById("valueDisplay");
    const radius = 120;
    const circumference = 2 * Math.PI * radius;
    const arcLength = circumference * (260 / 360);
    water.style.strokeDasharray = arcLength + " " + circumference;
    water.style.strokeDashoffset = arcLength;

    const minTemp = 0;
    const maxTemp = 50;

    function setLevel(temp) {
      const percent = ((temp - minTemp) / (maxTemp - minTemp)) * 100;
      const offset = arcLength - (percent / 100) * arcLength;
      water.style.strokeDashoffset = offset;
      valueDisplay.textContent = `${Math.round(temp)}¬∞C`;
    }

    function updateDashboard(d) {
      document.getElementById("suhu1").textContent = d.suhu1 + " ¬∞C";
      document.getElementById("kelembaban1").textContent = d.kelembaban1 + " %";
      document.getElementById("suhu2").textContent = d.suhu2 + " ¬∞C";
      document.getElementById("kelembaban2").textContent = d.kelembaban2 + " %";
      document.getElementById("uv_index").textContent = d.uv_index;
      document.getElementById("uv_intensity").textContent = d.uv_intensity;
      document.getElementById("debu").textContent = d.debu;
      document.getElementById("curah_hujan").textContent = d.curah_hujan;
      document.getElementById("kecepatan_angin").textContent = d.kecepatan_angin;
      document.getElementById("arah_angin").textContent = d.arah_angin;
      document.getElementById("irradiance").textContent = d.irradiance;
      let rataSuhu = ((d.suhu1 + d.suhu2) / 2).toFixed(1);
      document.getElementById("suhuUtama").textContent = rataSuhu + " ¬∞C";
      setLevel(d.suhu1);
      let kondisi;
      if (rataSuhu < 18) {kondisi = "Dingin";}
      else if (rataSuhu >= 18 && rataSuhu <= 26) {kondisi = "Normal";}
      else {kondisi = "Panas";}
      document.getElementById("kondisiCuaca").textContent = kondisi;
    }

    function formatRow(d) {
      return `
        <tr class="bg-white">
          <td class="border px-2 py-1">${d.timestamp}</td>
          <td class="border px-2 py-1">${d.device_id}</td>
          <td class="border px-2 py-1">${d.suhu1}</td>
          <td class="border px-2 py-1">${d.kelembaban1}</td>
          <td class="border px-2 py-1">${d.suhu2}</td>
          <td class="border px-2 py-1">${d.kelembaban2}</td>
          <td class="border px-2 py-1">${d.uv_index}</td>
          <td class="border px-2 py-1">${d.debu}</td>
          <td class="border px-2 py-1">${d.curah_hujan}</td>
          <td class="border px-2 py-1">${d.kecepatan_angin}</td>
          <td class="border px-2 py-1">${d.arah_angin}</td>
          <td class="border px-2 py-1">${d.irradiance}</td>
        </tr>
      `;
    }
    
    async function loadData() {
      const { data, error } = await supabaseClient
        .from('sensor_data')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(20);
      if (error) { console.error("Error loading data:", error); return; }
      dataBody.innerHTML = data.map(d => formatRow(d)).join("");
      if (data.length) updateDashboard(data[0]); // update dashboard dengan data terbaru
    }

    loadData();
    
    supabaseClient.channel('sensor-realtime')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sensor_data' }, payload => {
        const entry = payload.new;
        const tr = document.createElement("tr");
        tr.innerHTML = formatEntryRow(entry);
        tr.classList.add("new-entry");
        dataBody.prepend(tr);

        setTimeout(() => tr.classList.remove("new-entry"), 5000);

        // Batasi row maksimal 50
        while (dataBody.rows.length > 50) {
          dataBody.removeChild(dataBody.lastChild);
        }
      })
      .subscribe();
    function updateClock() {
      const now = new Date();
      const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID', options);
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    function showPage(page, el) {
      ["utama", "grafik", "histori"].forEach(id => document.getElementById(id).classList.add("hidden"));
      document.getElementById(page).classList.remove("hidden");
      document.querySelectorAll(".nav-link").forEach(btn => {
        btn.classList.remove("text-blue-600", "font-semibold", "border-b-2", "border-blue-600");
        btn.classList.add("text-gray-600");
      });
      if (el) {
        el.classList.remove("text-gray-600");
        el.classList.add("text-blue-600", "font-semibold", "border-b-2", "border-blue-600");
      }
      adjustContentOffset();
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const menuBtn = document.getElementById("menuBtn");
      const mobileMenu = document.getElementById("mobileMenu");
      if (menuBtn) menuBtn.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
      renderHistori();
    });
    
    function adjustContentOffset() {
      const header = document.querySelector("header");
      const pages = document.querySelectorAll("#utama, #grafik, #histori");
      if (header) {
        const offset = header.offsetHeight + 10;
        pages.forEach(page => page.style.paddingTop = offset + "px");
      }
    }
    window.addEventListener("load", adjustContentOffset);
    window.addEventListener("resize", adjustContentOffset);
    
    
  </script>
    <script>
      function toggleFooter(button) {
        const list = button.nextElementSibling;
        if (!list) return;
        list.classList.toggle("hidden");
        // ubah tanda + jadi -
        const icon = button.querySelector("span");
        if (icon) {
          icon.textContent = list.classList.contains("hidden") ? "+" : "‚àí";
        }
      }
    </script>
</body>
</html>
