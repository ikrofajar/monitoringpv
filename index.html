<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .param-card {
      width: 6rem;              /* w-24 */
      height: 6rem;             /* h-24 */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: white;  /* bg-white */
      border-radius: 1rem;      /* rounded-2xl */
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* shadow-md */
      transition: transform 0.3s; /* transition-transform duration-300 */
    }
    .param-card:hover {
      transform: scale(1.05);   /* hover:scale-105 */
    }
    @media (min-width: 640px) {
      .param-card {
        width: 7rem;  /* sm:w-28 */
        height: 7rem; /* sm:h-28 */
      }
    }
    @media (min-width: 768px) {
      .param-card {
        width: 8rem;  /* md:w-32 */
        height: 8rem; /* md:h-32 */
      }
    }
    </style>
</head>
  <body class="bg-white min-h-screen text-gray-900 font-sans flex flex-col">
  
  <!-- Header -->
  <header class="fixed top-0 left-0 w-full z-50 bg-white/40 backdrop-blur-xl border-b border-white/20 shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16 sm:h-20">
        
        <!-- Logo + Judul -->
        <div class="flex items-center gap-3 flex-wrap">
          <img src="assets/images/drpm.png" alt="Logo DRPM" class="h-14 w-14 sm:h-20 sm:w-20 object-contain">
          <img src="assets/images/untad.png" alt="Logo Untad" class="h-5 w-5 sm:h-8 sm:w-8 object-contain">
          <div>
            <h1 class="text-base sm:text-xl md:text-2xl font-bold text-gray-800 tracking-tight">Sistem Monitoring</h1>
            <p class="text-xs sm:text-sm text-gray-500">Universitas Tadulako</p>
          </div>
        </div>
        <!-- Navigasi (Desktop) -->
        <nav class="hidden md:flex items-center gap-8">
          <button onclick="showPage('utama', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Utama</button>
          <button onclick="showPage('grafik', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Grafik</button>
          <button onclick="showPage('histori', this)" class="nav-link px-3 py-2 rounded-lg text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition">Histori</button>
        </nav>

        <!-- Jam -->
        <span id="clock" class="block font-mono text-sm sm:text-base text-gray-600"></span>

        <!-- Tombol Mobile -->
        <div class="md:hidden">
          <button id="menuBtn" class="focus:outline-none text-xl text-gray-700 hover:text-blue-600 transition-colors duration-300">☰</button>
        </div>
      </div>
    </div>
    <!-- Menu Mobile -->
    <div id="mobileMenu" class="hidden md:hidden absolute top-20 inset-x-0 bg-white/95 backdrop-blur-xl border-t border-gray-200 shadow-lg animate-slide-down">
      <nav class="flex flex-col px-6 py-4 space-y-4">
        <button onclick="showPage('utama', this)" class="nav-link text-left">Utama</button>
        <button onclick="showPage('grafik', this)" class="nav-link text-left">Grafik</button>
        <button onclick="showPage('histori', this)" class="nav-link text-left">Histori</button>
      </nav>
    </div>
  </header>
    
    <div class="flex-1 pt-24">
      <div id="utama">
        <!-- Nilai Utama -->
        <div class="flex flex-col items-center">
          <div class="text-6xl font-bold text-gray-900" id="suhuUtama"></div>
          <div class="text-lg text-gray-600" id="kondisiCuaca">-</div>
          <h3 class="text-xl font-bold mt-2">Lokasi: Rumah Penelitian</h3>
        </div>

        <div class="flex flex-wrap justify-center gap-4 p-4">
          <div class="param-card">
            <div class="mb-1">🌡️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="suhu1">- °C</div>
            <div class="text-xs sm:text-sm text-gray-500">Suhu 1</div>
          </div>
          <div class="param-card">
            <div class="mb-1">💧</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kelembaban1">- %</div>
            <div class="text-xs sm:text-sm text-gray-500">Kelembapan 1</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🌡️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="suhu2">- °C</div>
            <div class="text-xs sm:text-sm text-gray-500">Suhu 2</div>
          </div>
          <div class="param-card">
            <div class="mb-1">💧</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kelembaban2">- %</div>
            <div class="text-xs sm:text-sm text-gray-500">Kelembapan 2</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🌬️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="kecepatan_angin">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Kecepatan Angin</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🧭</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="arah_angin">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Arah Angin</div>
          </div>
          <div class="param-card">
            <div class="mb-1">☀️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="uv_index">-</div>
            <div class="text-xs sm:text-sm text-gray-500">UV Index</div>
          </div>
          <div class="param-card">
            <div class="mb-1">☀️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="uv_intensity">-</div>
            <div class="text-xs sm:text-sm text-gray-500">UV Intensity</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🔆</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="irradiance">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Radiasi Matahari</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🌫️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="debu">- µg/m³</div>
            <div class="text-xs sm:text-sm text-gray-500">Debu</div>
          </div>
          <div class="param-card">
            <div class="mb-1">🌧️</div>
            <div class="text-sm sm:text-base md:text-lg font-semibold" id="curah_hujan">-</div>
            <div class="text-xs sm:text-sm text-gray-500">Curah Hujan</div>
          </div>
        </div>
      </div>
      <div id="grafik" class="hidden">
        <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Suhu</h2>
            <canvas id="chartSuhu"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Kelembaban</h2>
            <canvas id="chartKelembaban"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Kecepatan Angin</h2>
            <canvas id="chartAngin"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Arah Angin</h2>
            <canvas id="compass" width="360" height="360"></canvas>
            <div id="windInfo" class="mt-4 text-center">
              <p class="text-lg font-medium text-gray-900" id="chartArahAngin">Arah: 0° (Utara)</p>
            </div>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Sinar UV</h2>
            <canvas id="chartUV"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Radiasi Matahari</h2>
            <canvas id="chartRadiasi"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Debu</h2>
            <canvas id="chartDebu"></canvas>
          </div>
          <div class="p-4 bg-white rounded-2xl shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-gray-800">Curah Hujan</h2>
            <canvas id="chartHujan"></canvas>
          </div>
        </div>
      </div>
  
  <section class="p-4 mt-6">
    <h2 class="text-lg font-bold text-gray-800 mb-2">Histori Data Sensor</h2>
    <div class="overflow-x-auto bg-white rounded-xl shadow p-4">
      <table class="min-w-full border-collapse text-center">
        <thead>
          <tr class="bg-green-500 text-white">
            <th class="px-4 py-2">Timestamp</th>
            <th class="px-4 py-2">Device</th>
            <th class="px-4 py-2">Suhu1</th>
            <th class="px-4 py-2">Kelembaban1</th>
            <th class="px-4 py-2">Suhu2</th>
            <th class="px-4 py-2">Kelembaban2</th>
            <th class="px-4 py-2">UV Index</th>
            <th class="px-4 py-2">Debu</th>
            <th class="px-4 py-2">Curah Hujan</th>
            <th class="px-4 py-2">Kecepatan Angin</th>
            <th class="px-4 py-2">Arah Angin</th>
            <th class="px-4 py-2">Irradiance</th>
          </tr>
        </thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>
  </section>
  <script>
    const SUPABASE_URL = "https://bryjpjzvsadfvjwqgwak.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyeWpwanp2c2FkZnZqd3Fnd2FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzA0MDUsImV4cCI6MjA3NDAwNjQwNX0.1iWQJhtE02t4JTcutIPkzxmn2qyx-Z7JCKFDQ8itCw8";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const dataBody = document.getElementById("data-body");

    function updateDashboard(d) {
      document.getElementById("suhu1").textContent = d.suhu1 + " °C";
      document.getElementById("kelembaban1").textContent = d.kelembaban1 + " %";
      document.getElementById("suhu2").textContent = d.suhu2 + " °C";
      document.getElementById("kelembaban2").textContent = d.kelembaban2 + " %";
      document.getElementById("uv_index").textContent = d.uv_index;
      document.getElementById("uv_intensity").textContent = d.uv_intensity;
      document.getElementById("debu").textContent = d.debu;
      document.getElementById("curah_hujan").textContent = d.curah_hujan;
      document.getElementById("kecepatan_angin").textContent = d.kecepatan_angin;
      document.getElementById("arah_angin").textContent = d.arah_angin;
      document.getElementById("irradiance").textContent = d.irradiance;
    }

    function formatRow(d) {
      return `
        <tr class="bg-white">
          <td class="border px-2 py-1">${d.timestamp}</td>
          <td class="border px-2 py-1">${d.device_id}</td>
          <td class="border px-2 py-1">${d.suhu1}</td>
          <td class="border px-2 py-1">${d.kelembaban1}</td>
          <td class="border px-2 py-1">${d.suhu2}</td>
          <td class="border px-2 py-1">${d.kelembaban2}</td>
          <td class="border px-2 py-1">${d.uv_index}</td>
          <td class="border px-2 py-1">${d.debu}</td>
          <td class="border px-2 py-1">${d.curah_hujan}</td>
          <td class="border px-2 py-1">${d.kecepatan_angin}</td>
          <td class="border px-2 py-1">${d.arah_angin}</td>
          <td class="border px-2 py-1">${d.irradiance}</td>
        </tr>
      `;
    }
    
    async function loadData() {
      const { data, error } = await supabaseClient
        .from('sensor_data')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(20);
      if (error) { console.error("Error loading data:", error); return; }
      dataBody.innerHTML = data.map(d => formatRow(d)).join("");
      if (data.length) updateDashboard(data[0]); // update dashboard dengan data terbaru
    }

    loadData();
    
    supabaseClient.channel('sensor-realtime')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sensor_data' }, payload => {
        const entry = payload.new;
        const tr = document.createElement("tr");
        tr.innerHTML = formatEntryRow(entry);
        tr.classList.add("new-entry");
        dataBody.prepend(tr);

        setTimeout(() => tr.classList.remove("new-entry"), 5000);

        // Batasi row maksimal 50
        while (dataBody.rows.length > 50) {
          dataBody.removeChild(dataBody.lastChild);
        }
      })
      .subscribe();
    function updateClock() {
      const now = new Date();
      const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
      document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID', options);
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    function showPage(page, el) {
      ["utama", "grafik", "histori"].forEach(id => document.getElementById(id).classList.add("hidden"));
      document.getElementById(page).classList.remove("hidden");
      document.querySelectorAll(".nav-link").forEach(btn => {
        btn.classList.remove("text-blue-600", "font-semibold", "border-b-2", "border-blue-600");
        btn.classList.add("text-gray-600");
      });
      if (el) {
        el.classList.remove("text-gray-600");
        el.classList.add("text-blue-600", "font-semibold", "border-b-2", "border-blue-600");
      }
      adjustContentOffset();
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const menuBtn = document.getElementById("menuBtn");
      const mobileMenu = document.getElementById("mobileMenu");
      if (menuBtn) menuBtn.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
      renderHistori();
    });
    
    function adjustContentOffset() {
      const header = document.querySelector("header");
      const pages = document.querySelectorAll("#utama, #grafik, #histori");
      if (header) {
        const offset = header.offsetHeight + 10;
        pages.forEach(page => page.style.paddingTop = offset + "px");
      }
    }
    window.addEventListener("load", adjustContentOffset);
    window.addEventListener("resize", adjustContentOffset);
    
    function toggleFooter(button) {
      const list = button.nextElementSibling;
      if (!list) return;
      list.classList.toggle("hidden");
      // ubah tanda + jadi -
      const icon = button.querySelector("span");
      if (icon) {
        icon.textContent = list.classList.contains("hidden") ? "+" : "−";
      }
    }
  </script>
</body>
</html>
